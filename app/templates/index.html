<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote File Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/logs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/selected_list.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='assets/logo.png') }}">
    <script>window.SELECTED_FILES = {{ selected | tojson }};</script>
    <script src="{{ url_for('static', filename='js/index.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/logs.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/modal.js') }}" defer></script>
</head>

<body>
    <div class="main-container">
        <h1>Remote File Manager</h1>

        <div class="center-section">
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb">
                <a href="{{ url_for('main.index') }}">üè† Home</a>
                {% if current_path %}
                {% set parts = current_path.split('/') %}
                {% for i in range(parts|length) %}
                <span>/</span>
                {% if i == parts|length - 1 %}
                <span class="current">{{ parts[i] }}</span>
                {% else %}
                <a href="{{ url_for('main.index', req_path='/'.join(parts[:i+1])) }}">{{ parts[i] }}</a>
                {% endif %}
                {% endfor %}
                {% endif %}
            </div>

            <!-- Selection Info -->
            <div class="selection-info">
                <span class="count" id="selectionCount">{{ selected|length }}</span> file(s) selected across all folders
            </div>

            <form method="POST" id="fileForm">
                <div class="controls">
                    <button type="button" id="process_button" class="green">Process</button>
                    <button type="button" id="select_all_button" class="purple">Select All in Directory</button>
                    <button type="button" id="view_selected_button" class="orange">View Selected</button>
                    <button type="submit" name="clear_selection" value="clear" class="blue">Clear Selection</button>
                    <button type="submit" name="create_folder" id="create_folder" value="create_folder" class="blue">Create New Folder</button>
                    <button type="button" id="delete_button" class="red">Delete Selected</button>
                </div>

                <!-- Hidden submit for actual deletion -->
                <input type="hidden" name="delete" id="delete_input" value="">

                <div class="file-grid">
                    {% for file in files %}
                    <label
                        class="file-card {% if file.full_path in selected %}selected{% endif %} {% if not file.is_dir and file.name.lower().endswith(('dmix.mkv', 'dmix.mp4', 'dmix.avi', 'dmix.mov')) %}dmix-file{% endif %}"
                        data-filepath="{{ file.full_path }}" data-is-dir="{{ 'true' if file.is_dir else 'false' }}">

                        {% if file.is_dir %}
                        <div class="folder-checkbox-area" title="Click to select folder">
                            <input type="checkbox" name="selected_files" value="{{ file.full_path }}" {% if
                                file.full_path in selected %}checked{% endif %}>
                            <div class="checkbox-indicator"></div>
                        </div>
                        {% else %}
                        <input type="checkbox" name="selected_files" value="{{ file.full_path }}" {% if file.full_path
                            in selected %}checked{% endif %}>
                        {% endif %}

                        <!-- Kebab Menu Button -->
                        <div class="kebab-menu-container">
                            <button type="button" class="kebab-button" data-filepath="{{ file.full_path }}">
                                <span class="kebab-dots">‚ãÆ</span>
                            </button>
                            <div class="kebab-dropdown">
                                {% if file.is_dir %}
                                <button type="button" class="kebab-option" data-action="open">üìÇ Open</button>
                                <button type="button" class="kebab-option" data-action="select">‚úì Select</button>
                                <button type="button" class="kebab-option" data-action="rename">‚úèÔ∏è Rename</button>
                                <button type="button" class="kebab-option" data-action="delete">üóëÔ∏è Delete</button>
                                {% else %}
                                <button type="button" class="kebab-option" data-action="select">‚úì Select</button>
                                <!-- <button type="button" class="kebab-option" data-action="download">‚¨áÔ∏è Download</button> -->
                                <button type="button" class="kebab-option" data-action="rename">‚úèÔ∏è Rename</button>
                                <button type="button" class="kebab-option" data-action="delete">üóëÔ∏è Delete</button>
                                {% endif %}
                            </div>
                        </div>

                        <div class="file-icon">
                            {% if file.file_type == "folder" %}
                            üìÅ
                            {% elif file.file_type == "img" %}
                            <img src="{{ url_for('static', filename='assets/img.png') }}" alt="Movie" style="width: 75px;">
                            {% elif file.file_type == "vid" %}
                            <img src="{{ url_for('static', filename='assets/vid.png') }}" alt="Movie" style="width: 75px;">
                            {% elif file.file_type == "txt" %}
                            <img src="{{ url_for('static', filename='assets/txt.png') }}" alt="Movie" style="width: 75px;">
                            {% else %}
                            üìÑ
                            {% endif %}
                        </div>

                        <div class="file-name">
                            {% if file.file_type == "folder" %}
                            <a href="{{ url_for('main.index', req_path=(current_path + '/' + file.name) if current_path else file.name) }}"
                                onclick="event.stopPropagation()">
                                {{ file.name }}
                            </a>
                            {% else %}
                            {{ file.name }}
                            {% endif %}
                        </div>
                    </label>
                    {% endfor %}
                </div>

                <!-- Process Modal -->
                <div id="myModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2 style="margin-bottom: 20px;">Select Script</h2>
                        {% for script in scripts %}
                        <label>
                            <input type="radio" name="selected_script" value="{{script}}">
                            {{script}}
                        </label>
                        {% endfor %}
                        <button type="submit" name="process" value="process" class="green modal-button">Run</button>
                    </div>
                </div>

                <!-- Create Folder Modal -->
                <div id="createFolderModal" class="modal">
                    <div class="modal-content">
                        <span class="close" id="closeFolderModalBtn">&times;</span>
                        <h2 style="margin-bottom: 20px;">Enter Folder Name</h2>
                        <input type="text" id="folder_name_input" placeholder="New Folder" class="folder-input">
                        <button type="button" id="confirmCreateFolder" class="green modal-button">Create</button>
                    </div>
                </div>
                <input type="hidden" name="folder_name" id="folder_name_hidden">

                <!-- View Selected Modal -->
                <div id="viewSelectedModal" class="modal">
                    <div class="modal-content">
                        <span class="close" id="closeViewSelected">&times;</span>
                        <h2 style="margin-bottom: 20px;">Selected Files & Folders</h2>
                        <div id="selectedFilesList" class="selected-files-list">
                            <!-- Files will be populated here -->
                        </div>
                        <div class="modal-footer">
                            <p class="selected-count-info">Total: <span id="modalSelectionCount">0</span> items</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Logs Panel -->
        <div class="logs-panel">
            <div class="logs-header">
                <h2>Logs</h2>
                <button class="refresh-btn" onclick="refreshLogs()">‚Üª Refresh</button>
            </div>
            <div class="logs-content" id="logsContent">
                <div class="log-empty">No logs yet...</div>
            </div>
        </div>
    </div>
</body>

</html>