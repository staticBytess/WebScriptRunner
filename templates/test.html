<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web File Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/test_page.css') }}">
</head>

<body>
    <div class="container">
        <h1>Web File Manager</h1>

        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb">
            <a href="{{ url_for('index') }}">üè† Home</a>
            {% if current_path %}
            {% set parts = current_path.split('/') %}
            {% for i in range(parts|length) %}
            <span>/</span>
            {% if i == parts|length - 1 %}
            <span class="current">{{ parts[i] }}</span>
            {% else %}
            <a href="{{ url_for('index', req_path='/'.join(parts[:i+1])) }}">{{ parts[i] }}</a>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>

        <!-- Selection Info -->
        {% if selected|length > 0 %}
        <div class="selection-info">
            <span class="count">{{ selected|length }}</span> file(s) selected across all folders
        </div>
        {% endif %}

        <form method="POST" id="fileForm">
            <div class="controls">
                <button type="button" id="process_button" class="green">Process</button>
                <button type="submit" name="delete" value="delete" class="red">Delete Selected</button>
                <button type="submit" name="clear_selection" value="clear" class="blue">Clear Selection</button>
            </div>

            <div class="file-grid">
                {% for file in files %}
                <label class="file-card {% if file.full_path in selected %}selected{% endif %}"
                    data-filepath="{{ file.full_path }}">
                    <input type="checkbox" name="selected_files" value="{{ file.full_path }}" {% if file.full_path in
                        selected %}checked{% endif %}>

                    {% if file.is_dir %}
                    <div class="file-icon">üìÅ</div>
                    <div class="file-name">
                        <a href="{{ url_for('index', req_path=(current_path + '/' + file.name) if current_path else file.name) }}"
                            onclick="event.stopPropagation()">
                            {{ file.name }}
                        </a>
                    </div>
                    {% else %}
                    <div class="file-icon">üìÑ</div>
                    <div class="file-name">{{ file.name }}</div>
                    {% endif %}
                </label>
                {% endfor %}
            </div>

            <!-- Modal -->
            <div id="myModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2 style="margin-bottom: 20px;">Select Script</h2>
                    {% for script in scripts %}
                    <label>
                        <input type="radio" name="selected_script" value="{{script}}">
                        {{script}}
                    </label>
                    {% endfor %}
                    <button type="submit" name="process" value="process" class="green">Run</button>
                </div>
            </div>
        </form>
    </div>
    <script>
        // Handle file card selection with instant updates
        document.querySelectorAll('.file-card').forEach(card => {
            const checkbox = card.querySelector('input[type="checkbox"]');
            const filepath = card.dataset.filepath;

            card.addEventListener('click', async (e) => {
                // If clicking a link, allow normal behavior
                if (e.target.tagName === "A") {
                    return;
                }

                e.preventDefault();

                // Toggle the checkbox and visual state
                checkbox.checked = !checkbox.checked;
                card.classList.toggle('selected', checkbox.checked);

                // Send update to server immediately
                const action = checkbox.checked ? 'add' : 'remove';

                try {
                    const response = await fetch('/update_selection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: action,
                            filepath: filepath
                        })
                    });

                    if (!response.ok) {
                        console.error('Failed to update selection');
                        // Revert on failure
                        checkbox.checked = !checkbox.checked;
                        card.classList.toggle('selected', checkbox.checked);
                    }
                } catch (error) {
                    console.error('Error updating selection:', error);
                    // Revert on error
                    checkbox.checked = !checkbox.checked;
                    card.classList.toggle('selected', checkbox.checked);
                }
            });
        });

        // Modal functionality
        const modal = document.getElementById('myModal');
        const processBtn = document.getElementById('process_button');
        const closeBtn = document.querySelector('.close');

        processBtn.addEventListener('click', () => {
            const checkedBoxes = document.querySelectorAll('input[name="selected_files"]:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select at least one file');
                return;
            }
            modal.style.display = 'block';
        });

        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
</body>

</html>